<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <style>
        td.details-control {
            cursor: pointer;
        }

        td.details-control:before {
            content: '+';
            font-size: 16px;
            color: #333;
        }

        tr.shown td.details-control:before {
            content: '-';
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Mi Aplicación</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-url="/header_data/">Consultar Campaña</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#crearCampañaModal">Crear
                            Campaña</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard/">Dashboards</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Salir</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>Bienvenido a mi aplicación</h1>
        <p>Este es el contenido de la página de inicio.</p>
    </div>

    <div class="container mt-4">
        <div class="card">
            <div class="card-body">
                <table id="header-table" class="table table-striped" style="width:100%">
                    <thead>
                        <tr>
                            <th></th>
                            <th>ID</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                            <th>Descripción</th>
                            <th>Cantidad</th>
                            <th>Mensaje</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="crearCampañaModal" tabindex="-1" aria-labelledby="crearCampañaModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="crearCampañaModalLabel">Crear Nueva Campaña</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="headerForm" method="post">
                        {% csrf_token %}
                    </form>
                    <div id="form-errors" class="alert alert-danger" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="headerDetailsModal" tabindex="-1" aria-labelledby="headerDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="headerDetailsModalLabel">Detalles de Campaña</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body" id="headerDetailsBody">
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            var dataTable = $('#header-table').DataTable({
                processing: true,
                serverSide: true,
                ajax: "/header_data/",
                columns: [
                    { className: 'details-control', orderable: false, data: null, defaultContent: '' },
                    { data: "id" },
                    { data: "start_date" },
                    { data: "end_date" },
                    { data: "description" },
                    { data: "quantity" },
                    { data: "message" }
                ],
                order: [[1, 'asc']]
            });

            $('#header-table tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = dataTable.row(tr);

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    fetchDetailContent(row.data(), 1, row);
                    tr.addClass('shown');
                }
            });

            function fetchDetailContent(rowData, page, row) {
                $.ajax({
                    url: "/header_data/",
                    data: {
                        id: rowData.id,
                        detail_page: page
                    },
                    success: function (response) {
                        const entry = response.data.find(item => item.id === rowData.id);
                        const details = entry.details;
                        const total = entry.total_details;
                        const totalPages = Math.ceil(total / 5);

                        const maxPagesToShow = 10; // Número máximo de páginas a mostrar
                        let startPage = Math.max(1, page - Math.floor(maxPagesToShow / 2)); // Ajuste para mostrar la página actual en el centro
                        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

                        // Ajuste para mostrar siempre el número máximo de páginas
                        if (endPage - startPage + 1 < maxPagesToShow) {
                            startPage = Math.max(1, endPage - maxPagesToShow + 1);
                        }

                        let html = `
                            <div style="border: 1px solid #ddd; padding: 10px; margin-top: 10px;">
                                <h5>Detalles</h5>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr>
                                            <th style="border: 1px solid #ddd; padding: 5px;">DNI</th>
                                            <th style="border: 1px solid #ddd; padding: 5px;">Estado</th>
                                            <th style="border: 1px solid #ddd; padding: 5px;">Fecha Envío</th>
                                            <th style="border: 1px solid #ddd; padding: 5px;">Veces</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        $.each(details, function (_, detail) {
                            html += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 5px;">${detail.dni}</td>
                                    <td style="border: 1px solid #ddd; padding: 5px;">${detail.status ? 'Activo' : 'Inactivo'}</td>
                                    <td style="border: 1px solid #ddd; padding: 5px;">${detail.send_date}</td>
                                    <td style="border: 1px solid #ddd; padding: 5px;">${detail.times}</td>
                                </tr>
                            `;
                        });
                        html += `
                                    </tbody>
                                </table>
                                <div style="margin-top: 10px;" class="detail-pagination">
                        `;
                        for (let i = startPage; i <= endPage; i++) { // Usamos startPage y endPage
                            html += `<a href="#" data-page="${i}" style="margin-right:5px; padding:5px; border:1px solid #ddd; text-decoration:none;">${i}</a>`;
                        }
                        html += `<button class="btn btn-primary btn-sm" id="showDataButton" style="margin-left: 10px;" data-bs-toggle="modal" data-bs-target="#headerDetailsModal">Ver Datos</button></div></div>`;

                        row.child(html).show();

                        $('.detail-pagination a').off('click').on('click', function (e) {
                            e.preventDefault();
                            const newPage = parseInt($(this).data('page'));
                            fetchDetailContent(rowData, newPage, row);
                        });

                        $('#showDataButton').off('click').on('click', function () {
                            showHeaderDetailsModal(rowData);
                        });
                    }
                });
            }

            let currentHeaderId = null;  // Variable para almacenar el ID del Header

            function showHeaderDetailsModal(rowData) {
                currentHeaderId = rowData.id;  // Guardar el ID del Header
                let detailsHtml = `
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Detalles de Campaña</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>ID:</strong> ${rowData.id}</p>
                                    <p><strong>Fecha Inicio:</strong> ${rowData.start_date}</p>
                                    <p><strong>Fecha Fin:</strong> ${rowData.end_date}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Descripción:</strong> ${rowData.description}</p>
                                    <p><strong>Cantidad:</strong> ${rowData.quantity}</p>
                                    <p><strong>Mensaje:</strong> ${rowData.message}</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <input type="file" id="fileUpload" class="form-control">
                                <button id="uploadButton" class="btn btn-success mt-2">Cargar</button>
                            </div>
                        </div>
                    </div>
                `;
                $('#headerDetailsBody').html(detailsHtml);

                $('#uploadButton').off('click').on('click', function () {
                    var file = $('#fileUpload')[0].files[0];
                    if (file) {
                        var formData = new FormData();
                        formData.append('file', file);
                        formData.append('header_id', currentHeaderId);  // Enviar el ID del Header

                        $.ajax({
                            url: '/detail/upload/',  // La URL de tu vista de carga
                            type: 'POST',
                            data: formData,
                            contentType: false,
                            processData: false,
                            success: function (response) {
                                if (response.success) {
                                    alert('Archivo cargado con éxito.');
                                    $('#headerDetailsModal').modal('hide');
                                    dataTable.ajax.reload();  // Recargar la tabla principal
                                } else {
                                    alert('Error al cargar el archivo: ' + response.error);
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error("Error en la solicitud AJAX:", error);
                                alert('Error al comunicarse con el servidor.');
                            }
                        });
                    } else {
                        alert('Por favor, selecciona un archivo.');
                    }
                });
            }

            $('a[data-url]').click(function (e) {
                e.preventDefault();
                dataTable.ajax.reload();
            });

            $('#crearCampañaModal').on('show.bs.modal', function () {
                $.ajax({
                    url: "{% url 'header_create' %}",
                    type: 'GET',
                    success: function (data) {
                        $('#headerForm').html(data.form_html);
                    },
                    error: function () {
                        $('#headerForm').html('<div class="alert alert-danger">Error al cargar el formulario.</div>');
                    }
                });
            });

            $('#headerForm').submit(function (e) {
                e.preventDefault();
                $.ajax({
                    url: "{% url 'header_create' %}",
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function (response) {
                        if (response.success) {
                            $('#crearCampañaModal').modal('hide');
                            dataTable.ajax.reload();
                            // Limpiar el formulario y ocultar errores
                            $('#headerForm')[0].reset();
                            $('#form-errors').hide();
                        } else {
                            $('#form-errors').html(response.errors).show();
                        }
                    },
                    error: function () {
                        $('#form-errors').html('Error al enviar el formulario.').show();
                    }
                });
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>